// 
// 
// 

#include "HuffmanCoding.h"

unsigned int  HuffmanCodingClass::codeToHuffman(unsigned char zeros, signed int value, unsigned int &returnCode, unsigned char &returnCodeLength,
	unsigned int &returnCodeforValue, unsigned char &returnCodeforValueLength,
		unsigned char type, unsigned char color)
{
	unsigned int dcLuminance[12] = {
		0b0000000000000000, 0b0000000000000010, 0b0000000000000011, 0b0000000000000100, 0b0000000000000101, 0b0000000000000110, 0b0000000000001110, 0b0000000000011110, 0b0000000000111110, 0b0000000001111110,
		0b0000000011111110, 0b0000000111111110
	};

	unsigned int dcChrominance[12] = {
		0b0000000000000000, 0b0000000000000001, 0b0000000000000010, 0b0000000000000110, 0b0000000000001110, 0b0000000000011110, 0b0000000000111110, 0b0000000001111110, 0b0000000011111110, 0b0000000111111110,
		0b0000001111111110, 0b0000011111111110
	};

	unsigned int acLuminance[16][10] = {
			{ 0b0000000000000000, 0b0000000000000001, 0b0000000000000100, 0b0000000000001011, 0b0000000000011010, 0b0000000001111000, 0b0000000011111000, 0b0000001111110110, 0b1111111110000010, 0b1111111110000011 },
			{ 0b0000000000001100, 0b0000000000011011, 0b0000000001111001, 0b0000000111110110, 0b0000011111110110, 0b1111111110000100, 0b1111111110000101, 0b1111111110000110, 0b1111111110000111, 0b1111111110001000 },
			{ 0b0000000000011100, 0b0000000011111001, 0b0000001111110111, 0b0000111111110100, 0b1111111110001001, 0b1111111110001010, 0b1111111110001011, 0b1111111110001100, 0b1111111110001101, 0b1111111110001110 },
			{ 0b0000000000111010, 0b0000000111110111, 0b0000111111110101, 0b1111111110001111, 0b1111111110010000, 0b1111111110010001, 0b1111111110010010, 0b1111111110010011, 0b1111111110010100, 0b1111111110010101 },
			{ 0b0000000000111011, 0b0000001111111000, 0b1111111110010110, 0b1111111110010111, 0b1111111110011000, 0b1111111110011001, 0b1111111110011010, 0b1111111110011011, 0b1111111110011100, 0b1111111110011101 },
			{ 0b0000000001111010, 0b0000011111110111, 0b1111111110011110, 0b1111111110011111, 0b1111111110100000, 0b1111111110100001, 0b1111111110100010, 0b1111111110100011, 0b1111111110100100, 0b1111111110100101 },
			{ 0b0000000001111011, 0b0000111111110110, 0b1111111110100110, 0b1111111110100111, 0b1111111110101000, 0b1111111110101001, 0b1111111110101010, 0b1111111110101011, 0b1111111110101100, 0b1111111110101101 },
			{ 0b0000000011111010, 0b0000111111110111, 0b1111111110101110, 0b1111111110101111, 0b1111111110110000, 0b1111111110110001, 0b1111111110110010, 0b1111111110110011, 0b1111111110110100, 0b1111111110110101 },
			{ 0b0000000111111000, 0b0111111111000000, 0b1111111110110110, 0b1111111110110111, 0b1111111110111000, 0b1111111110111001, 0b1111111110111010, 0b1111111110111011, 0b1111111110111100, 0b1111111110111101 },
			{ 0b0000000111111001, 0b1111111110111110, 0b1111111110111111, 0b1111111111000000, 0b1111111111000001, 0b1111111111000010, 0b1111111111000011, 0b1111111111000100, 0b1111111111000101, 0b1111111111000110 },
			{ 0b0000000111111010, 0b1111111111000111, 0b1111111111001000, 0b1111111111001001, 0b1111111111001010, 0b1111111111001011, 0b1111111111001100, 0b1111111111001101, 0b1111111111001110, 0b1111111111001111 },
			{ 0b0000001111111001, 0b1111111111010000, 0b1111111111010001, 0b1111111111010010, 0b1111111111010011, 0b1111111111010100, 0b1111111111010101, 0b1111111111010110, 0b1111111111010111, 0b1111111111011000 },
			{ 0b0000001111111010, 0b1111111111011001, 0b1111111111011010, 0b1111111111011011, 0b1111111111011100, 0b1111111111011101, 0b1111111111011110, 0b1111111111011111, 0b1111111111100000, 0b1111111111100001 },
			{ 0b0000011111111000, 0b1111111111100010, 0b1111111111100011, 0b1111111111100100, 0b1111111111100101, 0b1111111111100110, 0b1111111111100111, 0b1111111111101000, 0b1111111111101001, 0b1111111111101010 },
			{ 0b1111111111101011, 0b1111111111101100, 0b1111111111101101, 0b1111111111101110, 0b1111111111101111, 0b1111111111110000, 0b1111111111110001, 0b1111111111110010, 0b1111111111110011, 0b1111111111110100 },
			{ 0b1111111111110101, 0b1111111111110110, 0b1111111111110111, 0b1111111111111000, 0b1111111111111001, 0b1111111111111010, 0b1111111111111011, 0b1111111111111100, 0b1111111111111101, 0b1111111111111110 } };

	unsigned int acChrominance[16][10] = {
			{ 0b0000000000000001, 0b0000000000000100, 0b0000000000001010, 0b0000000000011000, 0b0000000000011001, 0b0000000000111000, 0b0000000000111100, 0b0000000111110100, 0b0000001111110110, 0b0000111111110100 },
			{ 0b0000000000001011, 0b0000000000111001, 0b0000000011110110, 0b0000000111110101, 0b0000011111110110, 0b0000111111110101, 0b1111111110001000, 0b1111111110001001, 0b1111111110001010, 0b1111111110001011 },
			{ 0b0000000000011010, 0b0000000011110111, 0b0000001111110111, 0b0000111111110110, 0b0111111111000010, 0b1111111110001100, 0b1111111110001101, 0b1111111110001110, 0b1111111110001111, 0b1111111110010000 },
			{ 0b0000000000011011, 0b0000000011111000, 0b0000001111111000, 0b0000111111110111, 0b1111111110010001, 0b1111111110010010, 0b1111111110010011, 0b1111111110010100, 0b1111111110010101, 0b1111111110010110 },
			{ 0b0000000000111010, 0b0000000111110110, 0b1111111110010111, 0b1111111110011000, 0b1111111110011001, 0b1111111110011010, 0b1111111110011011, 0b1111111110011100, 0b1111111110011101, 0b1111111110011110 },
			{ 0b0000000000111011, 0b0000001111111001, 0b1111111110011111, 0b1111111110100000, 0b1111111110100001, 0b1111111110100010, 0b1111111110100011, 0b1111111110100100, 0b1111111110100101, 0b1111111110100110 },
			{ 0b0000000001111001, 0b0000011111110111, 0b1111111110100111, 0b1111111110101000, 0b1111111110101001, 0b1111111110101010, 0b1111111110101011, 0b1111111110101100, 0b1111111110101101, 0b1111111110101110 },
			{ 0b0000000001111010, 0b0000011111111000, 0b1111111110101111, 0b1111111110110000, 0b1111111110110001, 0b1111111110110010, 0b1111111110110011, 0b1111111110110100, 0b1111111110110101, 0b1111111110110110 },
			{ 0b0000000011111001, 0b1111111110110111, 0b1111111110111000, 0b1111111110111001, 0b1111111110111010, 0b1111111110111011, 0b1111111110111100, 0b1111111110111101, 0b1111111110111110, 0b1111111110111111 },
			{ 0b0000000111110111, 0b1111111111000000, 0b1111111111000001, 0b1111111111000010, 0b1111111111000011, 0b1111111111000100, 0b1111111111000101, 0b1111111111000110, 0b1111111111000111, 0b1111111111001000 },
			{ 0b0000000111111000, 0b1111111111001001, 0b1111111111001011, 0b1111111111001011, 0b1111111111001100, 0b1111111111001101, 0b1111111111001110, 0b1111111111001111, 0b1111111111010000, 0b1111111111010001 },
			{ 0b0000000111111001, 0b1111111111010010, 0b1111111111010011, 0b1111111111010100, 0b1111111111010101, 0b1111111111010110, 0b1111111111010111, 0b1111111111011000, 0b1111111111011001, 0b1111111111011010 },
			{ 0b0000000111111010, 0b1111111111011011, 0b1111111111011100, 0b1111111111011101, 0b1111111111011110, 0b1111111111011111, 0b1111111111100000, 0b1111111111100001, 0b1111111111100010, 0b1111111111100011 },
			{ 0b0000011111111001, 0b1111111111100100, 0b1111111111100101, 0b1111111111100110, 0b1111111111100111, 0b1111111111101000, 0b1111111111101001, 0b1111111111101010, 0b1111111111101011, 0b1111111111101100 },
			{ 0b0011111111100000, 0b1111111111101101, 0b1111111111101110, 0b1111111111101111, 0b1111111111110000, 0b1111111111110001, 0b1111111111110010, 0b1111111111110011, 0b1111111111110100, 0b1111111111110101 },
			{ 0b0111111111000011, 0b1111111111110110, 0b1111111111110111, 0b1111111111111000, 0b1111111111111001, 0b1111111111111010, 0b1111111111111011, 0b1111111111111100, 0b1111111111111101, 0b1111111111111110 } };


	value = validateValue(value, type);

	returnCodeforValue = codeForValue(value, returnCodeforValueLength); // calculate code for value and get length of this code
	

	if (color == JPEG_HUFFMAN_COLOR_Y){
		if (type == JPEG_HUFFMAN_DC)
		{
			returnCode = dcLuminance[returnCodeforValueLength];
			returnCodeLength = lengthOfCode(returnCode, JPEG_HUFFMAN_DC, JPEG_HUFFMAN_COLOR_Y);

		}
		else{
			if (returnCodeforValueLength == 0 && (zeros == 0 || zeros == 15))
			{
				if (zeros == 0)
				{
					returnCode = 0b0000000000001010;
					//Serial.println("EOB");
				}
				else{
					returnCode = 0b0000011111111001;
					//Serial.println("ZRL");
				}

				returnCodeLength = lengthOfCode(returnCode, JPEG_HUFFMAN_AC, JPEG_HUFFMAN_COLOR_Y);

			}
			else{
				returnCode = acLuminance[zeros][returnCodeforValueLength-1];
				returnCodeLength = lengthOfCode(returnCode, JPEG_HUFFMAN_AC, JPEG_HUFFMAN_COLOR_Y);
			}
		}

		

	}
	else
	{
		if (type == JPEG_HUFFMAN_DC)
		{
			returnCode = dcChrominance[returnCodeforValueLength];
			returnCodeLength = lengthOfCode(returnCode, JPEG_HUFFMAN_DC, JPEG_HUFFMAN_COLOR_CB_CR);
		}
		else{
			if (returnCodeforValueLength == 0 && (zeros == 0 || zeros == 15))
			{
				if (zeros == 0)
				{
					returnCode = 0;
					//Serial.println("EOB");
				}
				else{
					returnCode = 0b0000001111111010;
					//Serial.println("ZRL");
				}

				//returnCodeLength = lengthOfCode(returnCode, JPEG_HUFFMAN_DC, JPEG_HUFFMAN_COLOR_Y);

			}

			else{
				returnCode = acChrominance[zeros][returnCodeforValueLength-1];
			}
			
			returnCodeLength = lengthOfCode(returnCode, JPEG_HUFFMAN_AC, JPEG_HUFFMAN_COLOR_CB_CR);
		}
	}

}

unsigned int HuffmanCodingClass::codeForValue(signed int value, unsigned char &retLength)
{
	if (value == 0)
	{
		retLength = 0;
		return 0;
	}

	int absValue = abs(value);
	retLength = 0;   //category
	unsigned int testValue = 1; //multiply by 2
	unsigned int retValue = 0;

	while (testValue <= absValue){

		retLength++;
		testValue = testValue << 1;
	}

	//Serial.print("Value ");
	//Serial.print(value, DEC);
	//Serial.print(" Cat ");
	//Serial.println(length, DEC);


	if (value > 0) // positive values
	{
		retValue = powBy2(retLength - 1) + (value - powBy2(retLength - 1));
	}
	else //negative values
	{
		retValue = value + (powBy2(retLength) - 1);
	}

	return retValue;
}

unsigned int HuffmanCodingClass::powBy2(unsigned char exponent){
	unsigned int retVal = 1;
	for (unsigned char i = 0; i < exponent; i++)
	{
		retVal = retVal << 1;
	}

	return retVal;
}

unsigned char HuffmanCodingClass::lengthOfCode(unsigned int code, unsigned char type, unsigned char color){
	unsigned char ret = 2;
	if (code == 0)
	{
		return ret;
	}


	if (color == JPEG_HUFFMAN_COLOR_Y){
		if (type == JPEG_HUFFMAN_DC)
		{
			switch (code)
			{
			case 0b0000000000000010 : 
				ret = 3;
				return ret;
				break;
			

			case 0b0000000000000011:
				ret = 3;
				return ret;
				break;
			
			}
		}
		
		// AC LUMA
		else{
			if (code == 0b0000000000000001)
			{
				ret = 2;
				return ret;
			}
		}
	}

	//CHROMA
	else
	{
		// DC + AC
		if (code == 0b0000000000000001)
		{
				ret = 2;
				return ret;
		}
	}


	//only if code isn´t special variant

	ret = standardCodeLength(code);

	return ret;
}

unsigned char HuffmanCodingClass::standardCodeLength(unsigned int code){
	unsigned char length = 16;

	while (bitRead(code,length-1) == 0)
	{
		length--;
	}
	/*
	Serial.print("code ");
	Serial.print(code,BIN);
	Serial.print(" L ");
	Serial.println(length, DEC);
	*/
	return length;
}

signed int HuffmanCodingClass::validateValue(signed int value, unsigned char type){
	if (type == JPEG_HUFFMAN_DC)
	{
		if (value < (-2047))
		{
			return (-2047);
		}

		if (value > (2047))
		{
			return (2047);
		}

		else
		{
			return value;
		}

	}
	else{
		if (value < (-1023))
		{
			return (-1023);
		}

		if (value >(1023))
		{
			return (1023);
		}

		else
		{
			return value;
		}
	}
}

int  HuffmanCodingClass::decodeFromHuffman(unsigned int value, unsigned char length)
{
	int retVal = 0;
	
	if (length > 0) // for length 0 is value 0
	{
		if (bitRead(value, length - 1)){
			// positive value
			bitWrite(value, length - 1, 0); // reset sign bit
			retVal = bit(length - 1) + value;   // minimal positive value at length + additional value
		}

		else{
			//negative value
			retVal = -(bit(length) - 1) + value;  // minimal negative value at length + additional value
		}
	}
	return retVal;
}

unsigned char HuffmanCodingClass::getLengthOfValue(int value){
	unsigned char retVal = 0;
	value = abs(value);

	if (value > 0){
		retVal = 1;
		for (int i = 2; i <= value ; i = i * 2)
		{
			retVal++;
		}
	}

	return retVal;
}

HuffmanCodingClass HuffmanCoding;

